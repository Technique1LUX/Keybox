name: Prefill Igloo PINs

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  prefill:
    runs-on: ubuntu-latest
    steps:
      - name: Show target (no secrets)
        run: |
          echo "BASE: ${{ secrets.RENDER_BASE_URL }}"
          echo "PATH: /prefill?secret=***"

      - name: Wake up Render
        run: |
          curl -sS --max-time 30 --retry 6 --retry-all-errors \
            "${{ secrets.RENDER_BASE_URL }}/" >/dev/null || true
      - name: Debug PREFILL_URL (safe)
        run: |
          echo "PREFILL_URL (redacted):"
          echo "${{ secrets.PREFILL_URL }}" | sed -E 's/(secret=)[^&]+/\1***/g'
      - name: Call /prefill
        run: |
          URL="${{ secrets.RENDER_BASE_URL }}/prefill?secret=${{ secrets.PREFILL_SECRET }}"
          status=$(curl -sS -o resp.txt -w "%{http_code}" \
            --max-time 60 --retry 6 --retry-all-errors \
            "$URL")

          echo "HTTP STATUS: $status"
          echo "---- RESPONSE (first 2000 chars) ----"
          head -c 2000 resp.txt || true
          echo ""

          if [ "$status" != "200" ]; then
            exit 1
          fi
